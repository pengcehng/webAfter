# 视频监控管理系统 - 综合项目文档

![Vue.js](https://img.shields.io/badge/Vue.js-2.x-4FC08D?style=flat-square&logo=vue.js)
![Node.js](https://img.shields.io/badge/Node.js-14+-339933?style=flat-square&logo=node.js)
![Element UI](https://img.shields.io/badge/Element%20UI-2.x-409EFF?style=flat-square&logo=element)
![License](https://img.shields.io/badge/License-MIT-blue?style=flat-square)

## 📋 目录

- [项目概述](#项目概述)
- [核心功能](#核心功能)
- [技术栈](#技术栈)
- [项目结构](#项目结构)
- [快速开始](#快速开始)
- [测试账号](#测试账号)
- [数据回退机制](#数据回退机制)
- [API接口文档](#api接口文档)
- [开发指南](#开发指南)
- [贡献指南](#贡献指南)
- [许可证](#许可证)

## 🎯 项目概述

这是一个基于Vue.js的现代化视频监控管理系统，采用前后端分离架构，支持设备管理、实时监控、视频管理、数据统计等功能。系统具备完善的数据回退机制，确保在后端服务不可用时仍能正常运行。

### 系统特性

- 🚀 **开箱即用**: 内置测试数据，无需配置数据库
- 🎨 **现代化UI**: 基于Element UI的美观界面，响应式设计
- 🔧 **开发友好**: 热重载开发模式，完整的开发文档
- 🛡️ **数据回退**: 优先使用后端数据，自动切换到本地测试数据

## 🎯 核心功能

### 设备管理
- 设备信息管理（增删改查）
- 设备状态监控（在线、离线、维护中、故障）
- 设备位置管理
- 在线状态检测
- 设备类型分类（高压水枪、超声波、气压、刷式清洁器）
- 清洁模式管理（自动清洁、手动清洁、定时清洁）

### 视频监控
- 实时视频流监控
- 本地视频文件管理
- 视频录制和下载
- 视频质量监控
- 视频预览功能
- 多格式支持（MP4、AVI等）

### 数据统计
- 设备运行统计
- 视频存储统计
- 系统性能监控
- 可视化图表展示
- 实时数据更新

### 报警管理
- 实时报警监控
- 报警确认处理
- 报警统计分析
- 多级报警处理

### 数据回退机制
- 优先使用后端数据
- 自动切换到本地测试数据
- 透明的数据源切换
- 完整的功能支持

## 🛠️ 技术栈

### 前端技术
- **Vue.js 2.x**: 前端框架
- **Vue Router**: 路由管理
- **Element UI**: UI组件库
- **Axios**: HTTP客户端
- **Babel**: JavaScript编译器
- **ESLint**: 代码质量检查

### 后端技术
- **Node.js**: 运行环境
- **Express.js**: Web框架
- **CORS**: 跨域资源共享
- **JWT**: 身份验证

### 开发工具
- **Vue CLI**: 项目脚手架
- **Webpack**: 模块打包器
- **Hot Reload**: 热重载开发

## 📁 项目结构

```
webAfter/
├── public/                     # 静态资源目录
│   ├── favicon.ico            # 网站图标
│   └── index.html             # HTML模板
├── src/                       # 源代码目录
│   ├── App.vue               # 根组件
│   ├── main.js               # 应用入口文件
│   ├── api/                  # 后端服务目录
│   │   ├── server.js         # 后端服务入口文件
│   │   ├── routes/           # 路由目录
│   │   └── mockData/         # 模拟数据目录
│   ├── assets/               # 静态资源
│   │   ├── css/              # 样式文件
│   │   ├── images/           # 图片资源
│   │   └── styles/           # 全局样式
│   ├── components/           # 组件目录
│   │   ├── API/              # API服务层
│   │   │   ├── apiService.js # API服务主文件
│   │   │   └── mockData/     # 测试数据
│   │   ├── js/               # JavaScript逻辑文件
│   │   └── CSS/              # 组件样式文件
│   ├── router/               # 路由配置
│   │   └── index.js          # 路由定义文件
│   └── views/                # 页面组件
│       ├── AlarmPage/        # 报警管理页面
│       ├── CleaningTaskPage/ # 清洁任务页面
│       ├── DataStatisticesPage/ # 数据统计页面
│       ├── EquipmentPage/    # 设备管理页面
│       ├── LoginPage/        # 登录页面
│       ├── MainPage/         # 主页面
│       ├── MaintenancePage/  # 维护页面
│       ├── MonitoringPage/   # 监控页面
│       ├── StatePage/        # 状态页面
│       ├── UserPage/         # 用户页面
│       └── VideoPage/        # 视频页面
├── docs/                     # 项目文档
├── .editorconfig             # 编辑器配置
├── .gitignore                # Git忽略文件
├── babel.config.js           # Babel配置文件
├── jsconfig.json             # JavaScript配置文件
├── package.json              # 项目依赖
└── README.md                 # 项目说明
```

### 关键目录说明

#### `src/api/`
包含所有后端服务相关代码，包括Express服务器入口文件和API路由定义。

#### `src/views/`
包含应用的所有页面级组件，每个子目录代表一个页面。

#### `src/components/API/`
API服务层，包含数据回退机制的核心实现。

#### `src/router/`
包含Vue Router的配置，定义了应用的路由规则和导航。

## 🚀 快速开始

### 环境要求
- Node.js >= 14.0.0
- npm >= 6.0.0

### 安装依赖

```bash
# 安装前端依赖
npm install

# 安装后端依赖
cd backend
npm install
cd ..
```

### 开发模式运行

```bash
# 启动前端开发服务器
npm run serve

# 启动后端服务器（新终端窗口）
cd backend
node server.js
```

### 生产环境部署

```bash
# 构建前端
npm run build

# 部署dist目录到Web服务器
# 启动后端服务
cd backend
node server.js
```

### 访问地址
- **前端地址**: http://localhost:8080
- **后端地址**: http://localhost:3000

## 🧪 测试账号

### 主要测试账号
- **邮箱**: `test@test.com`
- **用户名**: `测试用户`
- **密码**: `test123`
- **角色**: `测试员`
- **权限**: `monitoring:view`（监控查看）

### 使用方法

#### 方法一：一键登录
1. 在登录页面点击 "🧪 测试账号登录" 按钮
2. 系统自动使用测试账号信息登录

#### 方法二：手动输入
1. 在登录表单的邮箱字段输入：`test@test.com` 或 `测试用户`
2. 在密码字段输入：`test123`
3. 点击登录按钮

### 其他预设账号
- **管理员账号**: `admin@example.com` / `password`
- **普通用户**: `user@example.com` / `password`

### 技术实现

#### 前端验证逻辑
- 登录时检查输入的邮箱/用户名和密码是否匹配测试账号
- 如果匹配，跳过后端API调用，直接在前端生成测试token
- 生成的token包含用户信息和权限数据

#### 存储信息
登录成功后，以下信息会保存到localStorage：
- `token`: 前端生成的测试JWT token
- `user`: 测试用户信息JSON
- `isTestAccount`: 标记为测试账号（值为'true'）

#### API请求处理
- 测试账号的API请求会添加 `X-Test-Account: true` 头部
- 不会发送Authorization头部到后端
- 401错误不会自动跳转到登录页

### 注意事项

1. **仅用于开发测试**: 此功能仅用于前端开发和测试，生产环境应禁用
2. **无后端验证**: 测试账号完全在前端验证，不依赖后端服务
3. **权限限制**: 测试账号只有监控查看权限，无法执行需要后端API的操作
4. **Token有效期**: 前端生成的token有效期为24小时

## 🛡️ 数据回退机制

### 概述

本项目实现了一套完整的数据回退（fallback）机制，确保在后端服务不可用时，前端仍能正常运行并展示测试数据。该机制优先使用后端响应数据，当后端不可用时自动切换到本地测试数据。

### 功能特性

#### 1. 设备管理数据回退
- **优先级**: 后端API > 本地测试数据
- **覆盖功能**: 设备列表查询、设备创建、更新、删除
- **支持特性**: 分页、搜索过滤、数据模拟

#### 2. 视频监控数据回退
- **优先级**: 后端API > 本地测试数据
- **覆盖功能**: 监控数据列表、本地视频列表
- **支持特性**: 分页、搜索过滤、视频预览、下载

#### 3. 新增视频管理页面
- **功能**: 专门的视频文件管理界面
- **特性**: 视频预览、下载、搜索、分页
- **路径**: `/MainPage/VideoPage`

### 技术实现

#### API服务层 (`apiService.js`)

```javascript
// 带fallback机制的设备列表获取
getEquipmentList: async (params = {}) => {
  try {
    // 优先尝试后端API
    const response = await apiClient.get('/equipment', { params })
    return response
  } catch (error) {
    console.warn('后端设备API不可用，使用测试数据:', error.message)
    // 使用本地测试数据
    return mockResponse
  }
}
```

#### 测试数据结构

##### 设备测试数据 (`equipmentMockData.js`)
- **设备列表**: 8个模拟设备，包含完整的设备信息
- **设备状态**: 运行中、离线、维护中、故障
- **清洁模式**: 自动清洁、手动清洁、定时清洁
- **设备类型**: 高压水枪、超声波、气压、刷式清洁器

##### 视频测试数据 (`videoMockData.js`)
- **本地视频**: 6个模拟视频文件，包含详细元数据
- **监控数据**: 6个监控设备状态信息
- **视频格式**: MP4格式，支持多种分辨率
- **文件信息**: 文件大小、时长、录制时间等

### 页面功能

#### 设备管理页面 (`EquipmentPage`)
- ✅ **数据获取**: 支持fallback机制
- ✅ **搜索功能**: 设备ID、安装位置搜索
- ✅ **CRUD操作**: 创建、读取、更新、删除设备
- ✅ **分页支持**: 完整的分页功能

#### 实时监控页面 (`MonitoringPage`)
- ✅ **数据获取**: 支持fallback机制
- ✅ **监控展示**: 实时监控数据展示
- ✅ **视频流**: 支持本地和远程视频流

#### 视频管理页面 (`VideoPage`) - 新增
- ✅ **视频列表**: 本地视频文件管理
- ✅ **搜索功能**: 设备ID、文件名搜索
- ✅ **视频预览**: 内置视频播放器
- ✅ **文件下载**: 支持视频文件下载
- ✅ **分页支持**: 完整的分页功能

### 使用方法

#### 1. 正常模式（后端可用）
当后端服务正常运行时，所有API调用将直接访问后端服务，获取真实数据。

#### 2. 离线模式（后端不可用）
当后端服务不可用时：
1. API调用会自动捕获错误
2. 在控制台输出警告信息
3. 自动切换到本地测试数据
4. 用户界面保持正常功能

#### 3. 测试数据特点
- **真实性**: 模拟数据贴近实际业务场景
- **完整性**: 包含所有必要的字段和属性
- **一致性**: 数据格式与后端API响应保持一致
- **可扩展**: 易于添加新的测试数据

### 配置说明

#### 模拟数据配置
测试数据位于 `src/components/API/mockData/` 目录：
- `equipmentMockData.js`: 设备管理相关数据
- `videoMockData.js`: 视频监控相关数据

#### 路由配置
新增的视频管理页面已添加到路由配置：
```javascript
{
  path: 'VideoPage',
  name: 'VideoPage',
  component: VideoPage
}
```

#### 菜单配置
主页面导航菜单已添加"视频管理"选项，位于"实时监控"和"数据统计"之间。

## 📚 API接口文档

### 概述

本文档描述了视频监控管理系统的所有API接口，包括前端API服务层和后端REST API接口。系统采用数据回退机制，优先使用后端数据，后端不可用时自动切换到本地测试数据。

### API服务架构

```
前端组件 → apiService.js → 后端API服务
                ↓
            数据回退机制
                ↓
            本地测试数据
```

### 前端API服务层

#### 文件位置
`src/components/API/apiService.js`

#### 核心功能
- 统一管理所有API调用
- 实现数据回退机制
- 处理请求和响应
- 错误处理和日志记录

### API服务方法

#### 设备管理API

##### `equipmentAPI.getEquipmentList(params)`
获取设备列表

**参数：**
```javascript
{
  page: 1,           // 页码
  pageSize: 10,      // 每页数量
  deviceId: '',      // 设备ID（可选）
  deviceName: '',    // 设备名称（可选）
  location: '',      // 位置（可选）
  status: ''         // 状态（可选）
}
```

**返回值：**
```javascript
{
  success: true,
  data: {
    list: [           // 设备列表
      {
        id: 1,
        deviceId: 'DEV001',
        deviceName: '前门摄像头',
        location: '主入口',
        status: 'online',
        lastOnline: '2024-01-15 10:30:00',
        quality: 95
      }
    ],
    total: 100,       // 总数量
    page: 1,          // 当前页码
    pageSize: 10      // 每页数量
  }
}
```

##### `equipmentAPI.addEquipment(data)`
添加设备

**参数：**
```javascript
{
  deviceId: 'DEV001',
  deviceName: '前门摄像头',
  location: '主入口',
  ip: '192.168.1.100',
  port: 8080
}
```

##### `equipmentAPI.updateEquipment(id, data)`
更新设备信息

##### `equipmentAPI.deleteEquipment(id)`
删除设备

#### 监控管理API

##### `monitoringAPI.getMonitoringList(params)`
获取监控列表

**参数：**
```javascript
{
  page: 1,
  pageSize: 10,
  deviceId: '',
  status: ''
}
```

**返回值：**
```javascript
{
  success: true,
  data: {
    list: [
      {
        id: 1,
        deviceId: 'MON001',
        deviceName: '前门监控',
        location: '主入口',
        status: 'recording',
        streamUrl: 'rtmp://example.com/live/stream1',
        quality: 'HD',
        lastUpdate: '2024-01-15 10:30:00'
      }
    ],
    total: 50
  }
}
```

##### `monitoringAPI.getLocalVideos(params)`
获取本地视频列表

**参数：**
```javascript
{
  page: 1,
  pageSize: 10,
  deviceId: '',
  fileName: '',
  startDate: '',
  endDate: ''
}
```

**返回值：**
```javascript
{
  success: true,
  data: {
    list: [
      {
        id: 1,
        fileName: 'video_20240115_103000.mp4',
        deviceId: 'DEV001',
        deviceName: '前门摄像头',
        location: '主入口',
        duration: '00:15:30',
        fileSize: '256MB',
        quality: 'HD',
        recordTime: '2024-01-15 10:30:00',
        status: 'completed',
        filePath: '/videos/video_20240115_103000.mp4'
      }
    ],
    total: 200
  }
}
```

#### 用户认证API

##### `authAPI.login(credentials)`
用户登录

**参数：**
```javascript
{
  username: 'admin',
  password: 'password'
}
```

**返回值：**
```javascript
{
  success: true,
  data: {
    token: 'jwt_token_here',
    user: {
      id: 1,
      username: 'admin',
      role: 'admin',
      permissions: ['read', 'write', 'delete']
    }
  }
}
```

##### `authAPI.logout()`
用户登出

##### `authAPI.getCurrentUser()`
获取当前用户信息

#### 统计数据API

##### `statisticsAPI.getOverviewData()`
获取概览数据

**返回值：**
```javascript
{
  success: true,
  data: {
    totalDevices: 25,
    onlineDevices: 23,
    totalVideos: 1500,
    todayRecordings: 45,
    storageUsed: '2.5TB',
    storageTotal: '10TB'
  }
}
```

##### `statisticsAPI.getChartData(type, period)`
获取图表数据

**参数：**
- `type`: 数据类型（'device', 'video', 'storage'）
- `period`: 时间周期（'day', 'week', 'month'）

#### 报警管理API

##### `alarmAPI.getAlarmList(params)`
获取报警列表

##### `alarmAPI.acknowledgeAlarm(id)`
确认报警

##### `alarmAPI.getAlarmStatistics()`
获取报警统计

### 后端REST API接口

#### 基础信息
- **基础URL**: `http://localhost:3000/api`
- **认证方式**: JWT Token
- **请求格式**: JSON
- **响应格式**: JSON

#### 通用响应格式

##### 成功响应
```javascript
{
  "success": true,
  "data": {}, // 具体数据
  "message": "操作成功"
}
```

##### 错误响应
```javascript
{
  "success": false,
  "error": {
    "code": "ERROR_CODE",
    "message": "错误描述"
  }
}
```

### 设备管理接口

#### GET `/api/equipment`
获取设备列表

**查询参数：**
- `page`: 页码（默认1）
- `pageSize`: 每页数量（默认10）
- `deviceId`: 设备ID筛选
- `deviceName`: 设备名称筛选
- `location`: 位置筛选
- `status`: 状态筛选

#### POST `/api/equipment`
添加设备

**请求体：**
```javascript
{
  "deviceId": "DEV001",
  "deviceName": "前门摄像头",
  "location": "主入口",
  "ip": "192.168.1.100",
  "port": 8080
}
```

#### PUT `/api/equipment/:id`
更新设备信息

#### DELETE `/api/equipment/:id`
删除设备

### 监控管理接口

#### GET `/api/monitoring`
获取监控列表

#### GET `/api/monitoring/videos`
获取本地视频列表

#### POST `/api/monitoring/start/:deviceId`
开始录制

#### POST `/api/monitoring/stop/:deviceId`
停止录制

### 用户认证接口

#### POST `/api/auth/login`
用户登录

**请求体：**
```javascript
{
  "username": "admin",
  "password": "password"
}
```

#### POST `/api/auth/logout`
用户登出

#### GET `/api/auth/me`
获取当前用户信息

**请求头：**
```
Authorization: Bearer <jwt_token>
```

### 统计数据接口

#### GET `/api/statistics/overview`
获取概览统计

#### GET `/api/statistics/charts`
获取图表数据

**查询参数：**
- `type`: 数据类型
- `period`: 时间周期

### 报警管理接口

#### GET `/api/alarms`
获取报警列表

#### PUT `/api/alarms/:id/acknowledge`
确认报警

#### GET `/api/alarms/statistics`
获取报警统计

### 数据回退机制

#### 工作原理
1. **优先后端**: 首先尝试调用后端API
2. **自动回退**: 后端不可用时自动使用本地测试数据
3. **透明切换**: 对前端组件透明，保持相同的数据格式
4. **状态提示**: 控制台输出当前使用的数据源

#### 测试数据

##### 设备测试数据
位置：`src/components/API/mockData/equipmentMockData.js`

包含8个模拟设备，涵盖不同状态和位置。

##### 视频测试数据
位置：`src/components/API/mockData/videoMockData.js`

包含6个本地视频文件和6个监控设备数据。

#### 配置选项

```javascript
// 在apiService.js中配置
const API_CONFIG = {
  baseURL: 'http://localhost:3000/api',
  timeout: 5000,
  fallbackEnabled: true,  // 启用数据回退
  logLevel: 'info'        // 日志级别
};
```

### 错误处理

#### 错误类型
- **网络错误**: 连接超时、网络不可达
- **认证错误**: Token过期、权限不足
- **业务错误**: 参数错误、数据不存在
- **服务器错误**: 内部服务器错误

## 🔧 开发指南

### 添加新的API fallback
1. 在对应的mockData文件中添加测试数据
2. 在apiService.js中包装API方法，添加try-catch逻辑
3. 确保测试数据格式与后端API响应一致

### 扩展测试数据
1. 修改mockData文件中的数据数组
2. 保持数据结构的一致性
3. 更新分页信息（total、pageSize等）

### 调试fallback机制
1. 关闭后端服务或修改API_BASE_URL
2. 检查浏览器控制台的警告信息
3. 验证页面功能是否正常

### 扩展测试账号
如需添加更多测试账号，修改 `LoginPage.js` 中的 `isTestAccount` 方法：

```javascript
isTestAccount (email, password) {
  const testAccounts = [
    { email: 'test@test.com', password: 'test123', username: '测试用户' },
    { email: '测试用户', password: 'test123', username: '测试用户' },
    // 添加新的测试账号
    { email: 'admin@test.com', password: 'admin123', username: '测试管理员' }
  ]
  
  return testAccounts.some(account => 
    (account.email === email || account.username === email) && 
    account.password === password
  )
}
```

### 注意事项

1. **数据一致性**: 确保测试数据格式与后端API响应格式完全一致
2. **错误处理**: fallback机制会在控制台输出警告，便于调试
3. **性能考虑**: 测试数据存储在内存中，大量数据时需要考虑性能影响
4. **安全性**: 测试数据不包含敏感信息，适合开发和演示环境

## 🤝 贡献指南

### 如何贡献

1. Fork 本仓库
2. 创建特性分支 (`git checkout -b feature/AmazingFeature`)
3. 提交更改 (`git commit -m 'Add some AmazingFeature'`)
4. 推送到分支 (`git push origin feature/AmazingFeature`)
5. 打开 Pull Request

### 开发流程

1. 在`src/api/routes/`下创建新的路由文件
2. 在`src/views/`下创建新的页面组件
3. 在`src/components/`下创建可复用组件
4. 更新相关文档
5. 提交代码并创建Pull Request

### 代码规范

- 遵循ESLint配置的代码规范
- 使用Vue.js官方推荐的代码风格
- 添加必要的注释和文档
- 确保代码通过所有测试

## 📄 许可证

本项目采用 MIT 许可证 - 查看 [LICENSE](LICENSE) 文件了解详情。

## 📞 联系方式

如有问题或建议，请通过以下方式联系：
- 提交 Issue
- 发送邮件
- 查看项目文档

---

**感谢使用视频监控管理系统！** 🎉

## 📝 更新日志

### v1.0.0 (当前版本)
- ✅ 实现设备管理数据fallback机制
- ✅ 实现视频监控数据fallback机制
- ✅ 新增视频管理页面
- ✅ 添加完整的测试数据集
- ✅ 更新路由和导航菜单
- ✅ 优化用户界面和交互体验
- ✅ 完善测试账号验证功能
- ✅ 整合所有项目文档

该系统确保了在各种网络环境下的可用性和稳定性，为用户提供了一致的使用体验。