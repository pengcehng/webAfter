# 数据回退机制文档

## 概述

本项目实现了一套完整的数据回退（fallback）机制，确保在后端服务不可用时，前端仍能正常运行并展示测试数据。该机制优先使用后端响应数据，当后端不可用时自动切换到本地测试数据。

## 功能特性

### 1. 设备管理数据回退
- **优先级**: 后端API > 本地测试数据
- **覆盖功能**: 设备列表查询、设备创建、更新、删除
- **支持特性**: 分页、搜索过滤、数据模拟

### 2. 视频监控数据回退
- **优先级**: 后端API > 本地测试数据
- **覆盖功能**: 监控数据列表、本地视频列表
- **支持特性**: 分页、搜索过滤、视频预览、下载

### 3. 新增视频管理页面
- **功能**: 专门的视频文件管理界面
- **特性**: 视频预览、下载、搜索、分页
- **路径**: `/MainPage/VideoPage`

## 技术实现

### API服务层 (`apiService.js`)

#### 设备管理API
```javascript
// 带fallback机制的设备列表获取
getEquipmentList: async (params = {}) => {
  try {
    // 优先尝试后端API
    const response = await apiClient.get('/equipment', { params })
    return response
  } catch (error) {
    console.warn('后端设备API不可用，使用测试数据:', error.message)
    // 使用本地测试数据
    return mockResponse
  }
}
```

#### 监控API
```javascript
// 带fallback机制的监控数据获取
getMonitoringList: async (params = {}) => {
  try {
    // 优先尝试后端API
    const response = await apiClient.get('/monitoring', { params })
    return response
  } catch (error) {
    console.warn('后端监控API不可用，使用测试数据:', error.message)
    // 使用本地测试数据
    return mockResponse
  }
}
```

### 测试数据结构

#### 设备测试数据 (`equipmentMockData.js`)
- **设备列表**: 8个模拟设备，包含完整的设备信息
- **设备状态**: 运行中、离线、维护中、故障
- **清洁模式**: 自动清洁、手动清洁、定时清洁
- **设备类型**: 高压水枪、超声波、气压、刷式清洁器

#### 视频测试数据 (`videoMockData.js`)
- **本地视频**: 6个模拟视频文件，包含详细元数据
- **监控数据**: 6个监控设备状态信息
- **视频格式**: MP4格式，支持多种分辨率
- **文件信息**: 文件大小、时长、录制时间等

## 页面功能

### 设备管理页面 (`EquipmentPage`)
- ✅ **数据获取**: 支持fallback机制
- ✅ **搜索功能**: 设备ID、安装位置搜索
- ✅ **CRUD操作**: 创建、读取、更新、删除设备
- ✅ **分页支持**: 完整的分页功能

### 实时监控页面 (`MonitoringPage`)
- ✅ **数据获取**: 支持fallback机制
- ✅ **监控展示**: 实时监控数据展示
- ✅ **视频流**: 支持本地和远程视频流

### 视频管理页面 (`VideoPage`) - 新增
- ✅ **视频列表**: 本地视频文件管理
- ✅ **搜索功能**: 设备ID、文件名搜索
- ✅ **视频预览**: 内置视频播放器
- ✅ **文件下载**: 支持视频文件下载
- ✅ **分页支持**: 完整的分页功能

## 使用方法

### 1. 正常模式（后端可用）
当后端服务正常运行时，所有API调用将直接访问后端服务，获取真实数据。

### 2. 离线模式（后端不可用）
当后端服务不可用时：
1. API调用会自动捕获错误
2. 在控制台输出警告信息
3. 自动切换到本地测试数据
4. 用户界面保持正常功能

### 3. 测试数据特点
- **真实性**: 模拟数据贴近实际业务场景
- **完整性**: 包含所有必要的字段和属性
- **一致性**: 数据格式与后端API响应保持一致
- **可扩展**: 易于添加新的测试数据

## 配置说明

### 模拟数据配置
测试数据位于 `src/components/API/mockData/` 目录：
- `equipmentMockData.js`: 设备管理相关数据
- `videoMockData.js`: 视频监控相关数据

### 路由配置
新增的视频管理页面已添加到路由配置：
```javascript
{
  path: 'VideoPage',
  name: 'VideoPage',
  component: VideoPage
}
```

### 菜单配置
主页面导航菜单已添加"视频管理"选项，位于"实时监控"和"数据统计"之间。

## 开发指南

### 添加新的API fallback
1. 在对应的mockData文件中添加测试数据
2. 在apiService.js中包装API方法，添加try-catch逻辑
3. 确保测试数据格式与后端API响应一致

### 扩展测试数据
1. 修改mockData文件中的数据数组
2. 保持数据结构的一致性
3. 更新分页信息（total、pageSize等）

### 调试fallback机制
1. 关闭后端服务或修改API_BASE_URL
2. 检查浏览器控制台的警告信息
3. 验证页面功能是否正常

## 注意事项

1. **数据一致性**: 确保测试数据格式与后端API响应格式完全一致
2. **错误处理**: fallback机制会在控制台输出警告，便于调试
3. **性能考虑**: 测试数据存储在内存中，大量数据时需要考虑性能影响
4. **安全性**: 测试数据不包含敏感信息，适合开发和演示环境

## 文件结构

```
src/
├── components/
│   ├── API/
│   │   ├── apiService.js          # API服务层，包含fallback逻辑
│   │   └── mockData/
│   │       ├── equipmentMockData.js  # 设备管理测试数据
│   │       └── videoMockData.js      # 视频监控测试数据
│   ├── js/
│   │   ├── EquipmentPage.js       # 设备管理页面逻辑
│   │   ├── MonitoringPage.js      # 监控页面逻辑
│   │   └── VideoPage.js           # 视频管理页面逻辑（新增）
│   └── CSS/
│       └── VideoPage.css          # 视频管理页面样式（新增）
├── views/
│   ├── EquipmentPage/
│   ├── MonitoringPage/
│   ├── VideoPage/                 # 视频管理页面（新增）
│   │   └── VideoPage.vue
│   └── MainPage/
│       └── MainPage.vue           # 主页面，包含导航菜单
└── router/
    └── index.js                   # 路由配置
```

## 更新日志

### v1.0.0 (当前版本)
- ✅ 实现设备管理数据fallback机制
- ✅ 实现视频监控数据fallback机制
- ✅ 新增视频管理页面
- ✅ 添加完整的测试数据集
- ✅ 更新路由和导航菜单
- ✅ 优化用户界面和交互体验

该机制确保了系统在各种网络环境下的可用性和稳定性，为用户提供了一致的使用体验。